<?xml version="1.0" encoding="utf-8"?>
<odoo>

        <template id="cfdiv40_extended_carta_porte" inherit_id="l10n_mx_edi.cfdiv40">
            <xpath expr="//*[name()='cfdi:Comprobante']" position="replace">
                <t t-if="carta_porte">
            <cfdi:Comprobante 
            xmlns:cfdi="http://www.sat.gob.mx/cfd/4"
            xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xmlns:cartaporte31="http://www.sat.gob.mx/CartaPorte31"
            xsi:schemaLocation="http://www.sat.gob.mx/cfd/4 http://www.sat.gob.mx/sitio_internet/cfd/4/cfdv40.xsd http://www.sat.gob.mx/CartaPorte31 http://www.sat.gob.mx/sitio_internet/cfd/CartaPorte/CartaPorte31.xsd "
            Version="4.0"
            t-att-Fecha="fecha"
            t-att-Folio="format_string(folio, 25)"
            t-att-Serie="format_string(serie, 40)"
            Sello="TO BE INJECTED"
            t-att-FormaPago="forma_pago"
            t-att-NoCertificado="no_certificado"
            t-att-Certificado="certificado"
            t-att-CondicionesDePago="format_string(condiciones_de_pago, 100)"
            t-att-SubTotal="format_float(subtotal)"
            t-att-Descuento="format_float(descuento)"
            t-att-Moneda="moneda"
            t-att-TipoCambio="format_float(tipo_cambio, precision=6)"
            t-att-Total="format_float(total)"
            t-att-TipoDeComprobante="tipo_de_comprobante"
            t-att-Exportacion="exportacion"
            t-att-MetodoPago="metodo_pago"
            t-att-LugarExpedicion="lugar_expedicion">
            <cfdi:InformacionGlobal t-if="information_global" t-att-Periodicidad="information_global['periodicidad']" t-att-Meses="information_global['meses']" t-att-Año="information_global['ano']"/>
            <cfdi:CfdiRelacionados t-if="tipo_relacion and cfdi_relationado_list" t-att-TipoRelacion="tipo_relacion">
                <t t-foreach="cfdi_relationado_list" t-as="cfdi_relationado">
                    <cfdi:CfdiRelacionado t-att-UUID="cfdi_relationado"/>
                </t>
            </cfdi:CfdiRelacionados>
            <cfdi:Emisor t-att-Rfc="emisor['rfc']" t-att-Nombre="format_string(emisor['nombre'], 254)" t-att-RegimenFiscal="emisor['regimen_fiscal']"/>
            <cfdi:Receptor t-att-Rfc="receptor['rfc']" t-att-Nombre="format_string(receptor['nombre'], 254)" t-att-ResidenciaFiscal="receptor['residencia_fiscal']" t-att-DomicilioFiscalReceptor="receptor['domicilio_fiscal_receptor']" t-att-RegimenFiscalReceptor="receptor['regimen_fiscal_receptor']" t-att-UsoCFDI="receptor['uso_cfdi']"/>
            <cfdi:Conceptos>
                <t t-foreach="conceptos_list" t-as="line_values">
                    <cfdi:Concepto t-att-ClaveProdServ="line_values['clave_prod_serv']" t-att-NoIdentificacion="format_string(line_values['no_identificacion'], 100)" t-att-Cantidad="format_float(line_values['cantidad'], precision=6)" t-att-ClaveUnidad="line_values['clave_unidad']" t-att-Unidad="format_string(line_values['unidad'], 20)" t-att-Descripcion="format_string(line_values['description'], 1000)" t-att-ValorUnitario="format_float(line_values['valor_unitario'])" t-att-Importe="format_float(line_values['importe'])" t-att-ObjetoImp="line_values['objeto_imp']" t-att-Descuento="format_float(line_values['descuento'])">
                        <cfdi:Impuestos t-if="line_values['traslados_list'] or line_values['retenciones_list']">
                            <cfdi:Traslados t-if="line_values['traslados_list']">
                                <t t-foreach="line_values['traslados_list']" t-as="tax_values">
                                    <cfdi:Traslado t-att-Base="format_float(tax_values['base'])" t-att-Importe="format_float(tax_values['importe'])" t-att-Impuesto="tax_values['impuesto']" t-att-TipoFactor="tax_values['tipo_factor']" t-att-TasaOCuota="format_float(tax_values['tasa_o_cuota'], precision=6)"/>
                                </t>
                            </cfdi:Traslados>
                            <cfdi:Retenciones t-if="line_values['retenciones_list']">
                                <t t-foreach="line_values['retenciones_list']" t-as="tax_values">
                                    <cfdi:Retencion t-att-Base="format_float(tax_values['base'])" t-att-Importe="format_float(tax_values['importe'])" t-att-Impuesto="tax_values['impuesto']" t-att-TipoFactor="tax_values['tipo_factor']" t-att-TasaOCuota="format_float(tax_values['tasa_o_cuota'], precision=6)"/>
                                </t>
                            </cfdi:Retenciones>
                        </cfdi:Impuestos>
                    </cfdi:Concepto>
                </t>
            </cfdi:Conceptos>
            <cfdi:Impuestos t-if="retenciones_reduced_list or traslados_list" t-att-TotalImpuestosTrasladados="format_float(total_impuestos_trasladados)" t-att-TotalImpuestosRetenidos="format_float(total_impuestos_retenidos)">
                <cfdi:Retenciones t-if="retenciones_reduced_list">
                    <t t-foreach="retenciones_reduced_list" t-as="tax_values">
                        <cfdi:Retencion t-att-Importe="format_float(tax_values['importe'])" t-att-Impuesto="tax_values['impuesto']"/>
                    </t>
                </cfdi:Retenciones>
                <cfdi:Traslados t-if="traslados_list">
                    <t t-foreach="traslados_list" t-as="tax_values">
                        <cfdi:Traslado t-att-Base="format_float(tax_values['base'])" t-att-Importe="format_float(tax_values['importe'])" t-att-Impuesto="tax_values['impuesto']" t-att-TipoFactor="tax_values['tipo_factor']" t-att-TasaOCuota="format_float(tax_values['tasa_o_cuota'], precision=6)"/>
                    </t>
                </cfdi:Traslados>
            </cfdi:Impuestos>
        </cfdi:Comprobante>
                </t>
                <t t-if="not carta_porte">
        <cfdi:Comprobante xmlns:cfdi="http://www.sat.gob.mx/cfd/4" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:cce20="http://www.sat.gob.mx/ComercioExterior20" xsi:schemaLocation="http://www.sat.gob.mx/cfd/4 http://www.sat.gob.mx/sitio_internet/cfd/4/cfdv40.xsd http://www.sat.gob.mx/Pagos20 http://www.sat.gob.mx/sitio_internet/cfd/Pagos/Pagos20.xsd http://www.sat.gob.mx/ComercioExterior20 http://www.sat.gob.mx/sitio_internet/cfd/ComercioExterior20/ComercioExterior20.xsd" Version="4.0" t-att-Fecha="fecha" t-att-Folio="format_string(folio, 25)" t-att-Serie="format_string(serie, 40)" Sello="TO BE INJECTED" t-att-FormaPago="forma_pago" t-att-NoCertificado="no_certificado" t-att-Certificado="certificado" t-att-CondicionesDePago="format_string(condiciones_de_pago, 100)" t-att-SubTotal="format_float(subtotal)" t-att-Descuento="format_float(descuento)" t-att-Moneda="moneda" t-att-TipoCambio="format_float(tipo_cambio, precision=6)" t-att-Total="format_float(total)" t-att-TipoDeComprobante="tipo_de_comprobante" t-att-Exportacion="exportacion" t-att-MetodoPago="metodo_pago" t-att-LugarExpedicion="lugar_expedicion">
            <cfdi:InformacionGlobal t-if="information_global" t-att-Periodicidad="information_global['periodicidad']" t-att-Meses="information_global['meses']" t-att-Año="information_global['ano']"/>
            <cfdi:CfdiRelacionados t-if="tipo_relacion and cfdi_relationado_list" t-att-TipoRelacion="tipo_relacion">
                <t t-foreach="cfdi_relationado_list" t-as="cfdi_relationado">
                    <cfdi:CfdiRelacionado t-att-UUID="cfdi_relationado"/>
                </t>
            </cfdi:CfdiRelacionados>
            <cfdi:Emisor t-att-Rfc="emisor['rfc']" t-att-Nombre="format_string(emisor['nombre'], 254)" t-att-RegimenFiscal="emisor['regimen_fiscal']"/>
            <cfdi:Receptor t-att-Rfc="receptor['rfc']" t-att-Nombre="format_string(receptor['nombre'], 254)" t-att-ResidenciaFiscal="receptor['residencia_fiscal']" t-att-DomicilioFiscalReceptor="receptor['domicilio_fiscal_receptor']" t-att-RegimenFiscalReceptor="receptor['regimen_fiscal_receptor']" t-att-UsoCFDI="receptor['uso_cfdi']"/>
            <cfdi:Conceptos>
                <t t-foreach="conceptos_list" t-as="line_values">
                    <cfdi:Concepto t-att-ClaveProdServ="line_values['clave_prod_serv']" t-att-NoIdentificacion="format_string(line_values['no_identificacion'], 100)" t-att-Cantidad="format_float(line_values['cantidad'], precision=6)" t-att-ClaveUnidad="line_values['clave_unidad']" t-att-Unidad="format_string(line_values['unidad'], 20)" t-att-Descripcion="format_string(line_values['description'], 1000)" t-att-ValorUnitario="format_float(line_values['valor_unitario'])" t-att-Importe="format_float(line_values['importe'])" t-att-ObjetoImp="line_values['objeto_imp']" t-att-Descuento="format_float(line_values['descuento'])">
                        <cfdi:Impuestos t-if="line_values['traslados_list'] or line_values['retenciones_list']">
                            <cfdi:Traslados t-if="line_values['traslados_list']">
                                <t t-foreach="line_values['traslados_list']" t-as="tax_values">
                                    <cfdi:Traslado t-att-Base="format_float(tax_values['base'])" t-att-Importe="format_float(tax_values['importe'])" t-att-Impuesto="tax_values['impuesto']" t-att-TipoFactor="tax_values['tipo_factor']" t-att-TasaOCuota="format_float(tax_values['tasa_o_cuota'], precision=6)"/>
                                </t>
                            </cfdi:Traslados>
                            <cfdi:Retenciones t-if="line_values['retenciones_list']">
                                <t t-foreach="line_values['retenciones_list']" t-as="tax_values">
                                    <cfdi:Retencion t-att-Base="format_float(tax_values['base'])" t-att-Importe="format_float(tax_values['importe'])" t-att-Impuesto="tax_values['impuesto']" t-att-TipoFactor="tax_values['tipo_factor']" t-att-TasaOCuota="format_float(tax_values['tasa_o_cuota'], precision=6)"/>
                                </t>
                            </cfdi:Retenciones>
                        </cfdi:Impuestos>
                    </cfdi:Concepto>
                </t>
            </cfdi:Conceptos>
            <cfdi:Impuestos t-if="retenciones_reduced_list or traslados_list" t-att-TotalImpuestosTrasladados="format_float(total_impuestos_trasladados)" t-att-TotalImpuestosRetenidos="format_float(total_impuestos_retenidos)">
                <cfdi:Retenciones t-if="retenciones_reduced_list">
                    <t t-foreach="retenciones_reduced_list" t-as="tax_values">
                        <cfdi:Retencion t-att-Importe="format_float(tax_values['importe'])" t-att-Impuesto="tax_values['impuesto']"/>
                    </t>
                </cfdi:Retenciones>
                <cfdi:Traslados t-if="traslados_list">
                    <t t-foreach="traslados_list" t-as="tax_values">
                        <cfdi:Traslado t-att-Base="format_float(tax_values['base'])" t-att-Importe="format_float(tax_values['importe'])" t-att-Impuesto="tax_values['impuesto']" t-att-TipoFactor="tax_values['tipo_factor']" t-att-TasaOCuota="format_float(tax_values['tasa_o_cuota'], precision=6)"/>
                    </t>
                </cfdi:Traslados>
            </cfdi:Impuestos>
        </cfdi:Comprobante>
                </t>
        </xpath>

            <!-- empieza complemento -->

            <xpath expr="//*[name()='cfdi:Comprobante']" position="inside">
                <t t-if="carta_porte">
                    <cfdi:Complemento
                            xmlns:cfdi="http://www.sat.gob.mx/cfd/4">
                        <cartaporte31:CartaPorte
                            xmlns:cartaporte31="http://www.sat.gob.mx/CartaPorte31"
                            Version="3.1" 
                            t-att-IdCCP= "carta_porte['cartaporte31']['IdCCP']"
                            t-att-TranspInternac= "carta_porte['cartaporte31']['TranspInternac']"
                            t-att-EntradaSalidaMerc= "carta_porte['cartaporte31']['EntradaSalidaMerc']"
                            t-att-ViaEntradaSalida= "carta_porte['cartaporte31']['ViaEntradaSalida']"
                            t-att-TotalDistRec= "carta_porte['cartaporte31']['TotalDistRec']"
                            t-att-PaisOrigenDestino= "carta_porte['cartaporte31']['PaisOrigenDestino']">
                            <t t-if="'Aduaneros' in carta_porte['cartaporte31']">
                                <t t-foreach="carta_porte['cartaporte31']['Aduaneros']" t-as="aduanera">
                                    <cartaporte31:RegimenAduaneroCCP
                                              t-att-RegimenAduanero="aduanera['RegimenAduanero']"/>
                                </t>
                            </t>
                            <cartaporte31:Ubicaciones>
                               <t t-foreach="carta_porte['cartaporte31']['Ubicaciones']" t-as="ubicacion">
                                  <cartaporte31:Ubicacion
                                        t-att-TipoUbicacion="ubicacion['TipoUbicacion']"
                                        t-att-RFCRemitenteDestinatario="ubicacion['RFCRemitenteDestinatario']"
                                        t-att-NombreRemitenteDestinatario="ubicacion['NombreRemitenteDestinatario']"
                                        t-att-NumRegIdTrib="ubicacion['NumRegIdTrib'] or None"
                                        t-att-ResidenciaFiscal="ubicacion['ResidenciaFiscal'] or None"
                                        t-att-NumEstacion="ubicacion['NumEstacion'] or None"
                                        t-att-NombreEstacion="ubicacion['NombreEstacion'] or None"
                                        t-att-FechaHoraSalidaLlegada="ubicacion['FechaHoraSalidaLlegada']"
                                        t-att-TipoEstacion="ubicacion['TipoEstacion'] or None"
                                        t-att-DistanciaRecorrida="ubicacion['DistanciaRecorrida'] or None">
                                     <t t-set="domicilio" t-value="ubicacion['Domicilio']"/>
                                     <cartaporte31:Domicilio
                                        t-att-Calle="domicilio['Calle']"
                                        t-att-NumeroExterior="domicilio['NumeroExterior']"
                                        t-att-NumeroInterior="domicilio['NumeroInterior'] or None"
                                        t-att-Colonia="domicilio['Colonia']"
                                        t-att-Municipio="domicilio['Municipio']"
                                        t-att-Localidad="domicilio['Localidad']"
                                        t-att-Estado="domicilio['Estado']"
                                        t-att-Pais="domicilio['Pais']"
                                        t-att-CodigoPostal="domicilio['CodigoPostal']"/>
                                  </cartaporte31:Ubicacion>
                               </t>
                            </cartaporte31:Ubicaciones>

                           <t t-set="mercancias" t-value="carta_porte['cartaporte31']['Mercancias']"/>
                            <cartaporte31:Mercancias
                                    t-att-NumTotalMercancias="mercancias['NumTotalMercancias']" 
                                    t-att-PesoBrutoTotal="mercancias['PesoBrutoTotal']"
                                    t-att-UnidadPeso="mercancias['UnidadPeso']"
                                    t-att-PesoNetoTotal="mercancias['PesoNetoTotal']"
                                    t-att-CargoPorTasacion="mercancias['CargoPorTasacion'] or None">
                                <t t-set="mercancia" t-value="mercancias['mercancia']"/>
                                <t t-foreach="mercancia['atributos']" t-as="atributos">
                                    <cartaporte31:Mercancia 
                                        t-att-BienesTransp="atributos['BienesTransp']"
                                        t-att-ClaveSTCC="atributos['ClaveSTCC']"
                                        t-att-Descripcion="atributos['Descripcion']"
                                        t-att-Cantidad="atributos['Cantidad']"
                                        t-att-ClaveUnidad="atributos['ClaveUnidad']"
                                        t-att-Unidad="atributos['Unidad']"
                                        t-att-Dimensiones="atributos['Dimensiones'] or None"
                                        t-att-MaterialPeligroso="atributos['MaterialPeligroso'] or None"
                                        t-att-CveMaterialPeligroso="atributos['CveMaterialPeligroso'] or None"
                                        t-att-Embalaje="atributos['Embalaje'] or None"
                                        t-att-DescripEmbalaje="atributos['DescripEmbalaje'] or None"
                                        t-att-SectorCOFEPRIS="atributos['SectorCofepris'] or None"
                                        t-att-NombreIngredienteActivo="atributos['IngredienteActivo'] or None"
                                        t-att-NomQuimico="atributos['NomQuimico'] or None"
                                        t-att-DenominacionGenericaProd="atributos['DenominacionGenerica'] or None"
                                        t-att-DenominacionDistintivaProd="atributos['DenominacionDistintiva'] or None"
                                        t-att-Fabricante="atributos['Fabricante'] or None"
                                        t-att-FechaCaducidad="atributos['FechaCaducidad'] or None"
                                        t-att-LoteMedicamento="atributos['LoteMedicamento'] or None"
                                        t-att-FormaFarmaceutica="atributos['FormaFarmaceutica'] or None"
                                        t-att-CondicionesEspTransp="atributos['CondicionesEsp'] or None"
                                        t-att-RegistroSanitarioFolioAutorizacion="atributos['RegistroSanitario'] or None"
                                        t-att-PermisoImportacion="atributos['PermisoImportacion'] or None"
                                        t-att-FolioImpoVUCEM="atributos['FolioImpoVUCEM'] or None"
                                        t-att-NumCAS="atributos['NumCAS'] or None"
                                        t-att-RazonSocialEmpImp="atributos['RazonSocialEmpImp'] or None"
                                        t-att-NumRegSanPlagCOFEPRIS="atributos['NumRegSan'] or None"
                                        t-att-DatosFabricante="atributos['DatosFabricante'] or None"
                                        t-att-DatosFormulador="atributos['DatosFormulador'] or None"
                                        t-att-DatosMaquilador="atributos['DatosMaquilador'] or None"
                                        t-att-UsoAutorizado="atributos['UsoAutorizado'] or None"
                                        t-att-TipoMateria="atributos['TipoMateria'] or None"
                                        t-att-DescripcionMateria="atributos['DescripcionMateria'] or None"
                                        t-att-PesoEnKg="atributos['PesoEnKg']"
                                        t-att-ValorMercancia="atributos['ValorMercancia']"
                                        t-att-FraccionArancelaria="atributos['FraccionArancelaria'] or None"
                                        t-att-Moneda="atributos['Moneda'] if atributos['ValorMercancia'] else None"/>
                                </t>
                                <t t-if="'DocumentacionAduanera' in mercancia">
                                    <t t-foreach="mercancia['DocumentacionAduanera']" t-as="aduanera">
                                        <cartaporte31:DocumentacionAduanera
                                              t-att-TipoDocumento="aduanera['TipoDocumento']"
                                              t-att-NumPedimento="aduanera['NumPedimento']"
                                              t-att-IdentDocAduanero="aduanera['IdentDocAduanero']"
                                              t-att-RFCImpo="aduanera['RFCImpo']"/>
                                    </t>
                                </t>
                                <t t-if="mercancias['Autotransporte']">
                                        <t t-set="transporte" t-value="mercancias['Autotransporte']"/>
                                        <cartaporte31:Autotransporte
                                            t-att-PermSCT="transporte['PermSCT']"
                                            t-att-NumPermisoSCT= "transporte['NumPermisoSCT']">
                                            <t t-set="idvehicular" t-value="transporte['IdentificacionVehicular']"/>
                                            <cartaporte31:IdentificacionVehicular
                                                t-att-ConfigVehicular="idvehicular['ConfigVehicular']"
                                                t-att-PesoBrutoVehicular="idvehicular['PesoBrutoVehicular']"
                                                t-att-PlacaVM="idvehicular['PlacaVM']"
                                                t-att-AnioModeloVM="idvehicular['AnioModeloVM']"/>
                                            <t t-set="seguro" t-value="transporte['Seguros']"/>
                                            <cartaporte31:Seguros
                                                t-att-AseguraRespCivil="seguro['AseguraRespCivil']"
                                                t-att-PolizaRespCivil="seguro['PolizaRespCivil']"
                                                t-att-AseguraCarga="seguro['AseguraCarga']"
                                                t-att-PolizaCarga="seguro['PolizaCarga']"
                                                t-att-PrimaSeguro="seguro['PrimaSeguro']"
                                                t-att-AseguraMedAmbiente="seguro['AseguraMedAmbiente']"
                                                t-att-PolizaMedAmbiente="seguro['PolizaMedAmbiente']"/>
                                            <t t-if="'Remolques' in transporte">
                                               <cartaporte31:Remolques>
                                                  <t t-foreach="transporte['Remolques']" t-as="remolque">
                                                      <cartaporte31:Remolque
                                                         t-att-SubTipoRem="remolque['SubTipoRem']"
                                                         t-att-Placa="remolque['Placa']"/>
                                                  </t>
                                               </cartaporte31:Remolques>
                                            </t>
                                        </cartaporte31:Autotransporte>
                                </t>
                            </cartaporte31:Mercancias>

                            <t t-set="figuras" t-value="carta_porte['cartaporte31']['FiguraTransporte']"/>
                            <cartaporte31:FiguraTransporte>
                                <t t-foreach="figuras" t-as="figura">
                                     <t t-set="tipofigura" t-value="figura['TiposFigura']"/>
                                     <cartaporte31:TiposFigura
                                                 t-att-TipoFigura="tipofigura['TipoFigura']"
                                                 t-att-RFCFigura="tipofigura['RFCFigura']"
                                                 t-att-NumLicencia="tipofigura['NumLicencia']"
                                                 t-att-NombreFigura="tipofigura['NombreFigura']"
                                                 t-att-NumRegIdTribFigura="tipofigura['NumRegIdTribFigura'] or None"
                                                 t-att-ResidenciaFiscalFigura="tipofigura['ResidenciaFiscalFigura'] or None">
                                                 <t t-set="partestransporte" t-value="figura['PartesTransporte']"/>
                                                 <t t-foreach="partestransporte" t-as="parte">
                                                     <cartaporte31:PartesTransporte
                                                          t-att-ParteTransporte="parte['ParteTransporte']">
                                                     </cartaporte31:PartesTransporte>
                                                 </t>
                                                 <t t-set="domicilio_ft" t-value="tipofigura['Domicilio']"/>
                                                 <cartaporte31:Domicilio
                                                     t-att-Calle="domicilio_ft['Calle']"
                                                     t-att-NumeroExterior="domicilio_ft['NumeroExterior']"
                                                     t-att-Colonia="domicilio_ft['Colonia']"
                                                     t-att-Localidad="domicilio_ft['Localidad']"
                                                     t-att-Municipio="domicilio_ft['Municipio']"
                                                     t-att-Estado="domicilio_ft['Estado']"
                                                     t-att-Pais="domicilio_ft['Pais']"
                                                     t-att-CodigoPostal="domicilio_ft['CodigoPostal']"/>
                                     </cartaporte31:TiposFigura>
                                </t>
                            </cartaporte31:FiguraTransporte>

                       </cartaporte31:CartaPorte>
                    </cfdi:Complemento>
                </t>
            </xpath>

        </template>

</odoo>
